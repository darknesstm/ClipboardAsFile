# 快速发布指南

## 发布新版本的完整流程

### 1. 准备发布

确保所有代码已提交并测试通过：

```bash
# 查看当前状态
git status

# 提交所有更改
git add .
git commit -m "Prepare for release v1.1.0"

# 确保本地代码是最新的
git pull origin master
```

### 2. 创建版本标签

```bash
# 创建带注释的标签
git tag -a v1.1.0 -m "Release version 1.1.0

主要更新：
- 添加双快捷键支持
- 实现 Explorer 专用 Drop
- 添加气泡通知系统
- 修复多行文本处理问题
"

# 查看标签
git tag -l
git show v1.1.0
```

### 3. 推送到 GitHub

```bash
# 推送代码
git push origin master

# 推送标签（这会触发自动构建和发布）
git push origin v1.1.0
```

### 4. 监控构建过程

1. 访问 https://github.com/darknesstm/ClipboardAsFile/actions
2. 查看 "Build Multi-Platform" workflow 运行状态
3. 等待构建完成（约 5-10 分钟）

构建过程：
```
开始 → 签出代码 → 设置 MSBuild → 恢复 NuGet 包
  ↓
编译 x64 版本 → 准备发布文件 → 上传 x64 产物
  ↓
编译 Win32 版本 → 准备发布文件 → 上传 Win32 产物
  ↓
下载所有产物 → 创建 ZIP 压缩包 → 创建 GitHub Release
  ↓
完成 ?
```

### 5. 验证发布

1. 访问 https://github.com/darknesstm/ClipboardAsFile/releases
2. 确认新版本已创建
3. 检查内容：
   - ? v1.1.0 标题
   - ? ClipboardAsFile-v1.1.0-x64.zip
   - ? ClipboardAsFile-v1.1.0-Win32.zip
   - ? Release Notes

4. 下载并测试：
   ```bash
   # 下载 x64 版本
   # 解压并运行
   # 测试主要功能
   ```

## 版本号管理

### 语义化版本

格式：`v主版本.次版本.修订号`

**何时递增：**

| 类型 | 说明 | 示例 |
|------|------|------|
| 主版本 | 不兼容的 API 修改 | v1.0.0 → v2.0.0 |
| 次版本 | 向下兼容的功能新增 | v1.0.0 → v1.1.0 |
| 修订号 | 向下兼容的问题修正 | v1.1.0 → v1.1.1 |

**示例：**

```bash
# 修复 Bug
git tag -a v1.1.1 -m "Fix: 修复气泡通知不显示的问题"

# 添加新功能
git tag -a v1.2.0 -m "Feature: 添加自定义文件名模板"

# 重大更新
git tag -a v2.0.0 -m "Breaking: 重构配置系统，不兼容旧版配置"
```

## 常用命令

### 标签管理

```bash
# 列出所有标签
git tag -l

# 查看标签详情
git show v1.1.0

# 删除本地标签
git tag -d v1.1.0

# 删除远程标签
git push origin :refs/tags/v1.1.0

# 重新创建标签
git tag -a v1.1.0 -m "Updated release notes"
git push origin v1.1.0 --force
```

### 发布管理

```bash
# 查看最新发布
git describe --tags --abbrev=0

# 查看标签之间的提交
git log v1.0.0..v1.1.0 --oneline

# 生成 Changelog
git log v1.0.0..v1.1.0 --pretty=format:"- %s (%an)" > CHANGELOG.md
```

## 快速发布脚本

创建 `release.sh`（Git Bash）：

```bash
#!/bin/bash

# 快速发布脚本
VERSION=$1

if [ -z "$VERSION" ]; then
    echo "用法: ./release.sh v1.1.0"
    exit 1
fi

echo "准备发布 $VERSION..."

# 1. 确保代码是最新的
git pull origin master || exit 1

# 2. 运行测试（如果有）
echo "运行测试..."
# TODO: 添加测试命令

# 3. 创建标签
echo "创建标签 $VERSION..."
git tag -a $VERSION -m "Release $VERSION" || exit 1

# 4. 推送
echo "推送到 GitHub..."
git push origin master || exit 1
git push origin $VERSION || exit 1

echo "? 发布完成！"
echo "监控构建: https://github.com/darknesstm/ClipboardAsFile/actions"
echo "查看发布: https://github.com/darknesstm/ClipboardAsFile/releases"
```

使用方法：
```bash
chmod +x release.sh
./release.sh v1.1.0
```

## 或使用 PowerShell 脚本

创建 `release.ps1`：

```powershell
param(
    [Parameter(Mandatory=$true)]
    [string]$Version
)

Write-Host "准备发布 $Version..." -ForegroundColor Green

# 1. 确保代码是最新的
Write-Host "拉取最新代码..."
git pull origin master
if ($LASTEXITCODE -ne 0) { exit 1 }

# 2. 创建标签
Write-Host "创建标签 $Version..."
git tag -a $Version -m "Release $Version"
if ($LASTEXITCODE -ne 0) { exit 1 }

# 3. 推送
Write-Host "推送到 GitHub..."
git push origin master
git push origin $Version

if ($LASTEXITCODE -eq 0) {
    Write-Host "? 发布完成！" -ForegroundColor Green
    Write-Host "监控构建: https://github.com/darknesstm/ClipboardAsFile/actions"
    Write-Host "查看发布: https://github.com/darknesstm/ClipboardAsFile/releases"
} else {
    Write-Host "? 发布失败！" -ForegroundColor Red
    exit 1
}
```

使用方法：
```powershell
.\release.ps1 -Version v1.1.0
```

## 测试构建（不发布）

如果只想测试构建而不创建 Release：

```bash
# 推送到 master 分支会触发构建但不会创建 Release
git push origin master

# 或者在 GitHub Actions 页面手动触发
# Actions → Build Multi-Platform → Run workflow
```

## 紧急回滚

如果发布的版本有严重问题：

```bash
# 1. 删除 GitHub Release（在网页上操作）

# 2. 删除标签
git tag -d v1.1.0
git push origin :refs/tags/v1.1.0

# 3. 修复问题后重新发布
git commit -m "Fix critical issue"
git tag -a v1.1.1 -m "Hotfix: 修复严重问题"
git push origin master
git push origin v1.1.1
```

## 预发布版本

创建预发布版本（beta/rc）：

```bash
# Beta 版本
git tag -a v1.2.0-beta.1 -m "Beta release"
git push origin v1.2.0-beta.1

# Release Candidate
git tag -a v1.2.0-rc.1 -m "Release candidate"
git push origin v1.2.0-rc.1

# GitHub Actions 会自动标记为 pre-release
```

## 检查清单

发布前确认：

- [ ] 所有代码已提交
- [ ] 本地测试通过
- [ ] 文档已更新
- [ ] 版本号正确递增
- [ ] CHANGELOG 已更新（如有）
- [ ] RC 文件已更新（如修改了对话框）

发布后确认：

- [ ] GitHub Actions 构建成功
- [ ] Release 页面正常
- [ ] 两个平台的 ZIP 都可下载
- [ ] 解压后程序可正常运行
- [ ] Release Notes 正确显示

## 获取帮助

- GitHub Actions 文档：https://docs.github.com/actions
- 语义化版本：https://semver.org/lang/zh-CN/
- Git 标签：https://git-scm.com/book/zh/v2/Git-基础-打标签

---

**当前仓库：** https://github.com/darknesstm/ClipboardAsFile  
**Actions 页面：** https://github.com/darknesstm/ClipboardAsFile/actions  
**Releases 页面：** https://github.com/darknesstm/ClipboardAsFile/releases
